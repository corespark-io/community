---
export const prerender = false;
import Layout from "../../layouts/Layout.astro";
import { Icon } from 'astro-icon/components';
import {
  MEMBERSHIP_PREFIXES,
  MEMBERSHIP_LEVEL_NAMES,
  MEMBERSHIP_LEVEL_DESCRIPTIONS } from "../../consts";
import "../../styles/base.css";

// --- Data Fetching Logic ---
async function findMember(id: string) {
  if (!id) {
    return { data: null, error: "No Member ID provided." };
  }

  const prefix = id.split(".")[0];
  const memberTypeDir = MEMBERSHIP_PREFIXES[prefix];

  if (!memberTypeDir) {
    return { data: null, error: `Invalid member ID prefix: '${prefix}'.` };
  }

  const path = `/src/data/members/${memberTypeDir}/${id}.json`;
  const memberFiles = import.meta.glob("/src/data/members/**/*.json");

  if (memberFiles[path]) {
    const memberModule = await memberFiles[path]();
    // The actual data is on the 'default' property for JSON imports
    return { data: memberModule.default, error: null };
  } else {
    return { data: null, error: `Member with ID '${id}' not found.` };
  }
}

// --- Request Handling ---
const url = Astro.url;
const wantsJson = url.searchParams.get("json") === "true";
let memberIdFromQuery = url.searchParams.get("id");

// Handle JSON API request
if (wantsJson) {
  if (!memberIdFromQuery) {
    return new Response(JSON.stringify({ error: "Member ID is required via the 'id' query parameter." }), {
      status: 400,
      headers: { "Content-Type": "application/json" },
    });
  }
  const { data, error } = await findMember(memberIdFromQuery);

  if (data) {
    const isExpired =
      new Date(data.verification.verification_expiry) < new Date();
    if (isExpired) {
      data.status = {
        code: "Expired",
        message: `Membership expired on ${new Date(
          data.verification.verification_expiry
        ).toLocaleDateString()}.`,
        updated_by: "System",
        updated_on: new Date().toISOString(),
      };
    }
  }
  const responseBody = error ? { error } : data;
  const status = error ? 404 : 200;

  return new Response(JSON.stringify(responseBody), {
    status,
    headers: { "Content-Type": "application/json" },
  });
}

// --- Page Rendering Logic ---
let memberData = null;
let error = null;
let memberId = memberIdFromQuery || "";

if (Astro.request.method === "GET" && memberIdFromQuery) {
  const { data: getData, error: getError } = await findMember(memberIdFromQuery);
  memberData = getData;
  error = getError;
} else if (Astro.request.method === "POST") {
  const contentType = Astro.request.headers.get("content-type");
  if (
    contentType === "application/x-www-form-urlencoded" ||
    contentType === "multipart/form-data"
  ) {
    try {
      const formData = await Astro.request.formData();
      memberId = formData.get("memberId") as string;
      const { data: postData, error: postError } = await findMember(memberId);
      memberData = postData;
      error = postError;
    } catch (e) {
      console.error(e);
      error = "An error occurred while verifying the member.";
    }
  } else {
    error = "Invalid request. Please try submitting the form again.";
  }
}
---

<Layout title="Verify Member">
  <main class="container">
    <h1>Member Verification</h1>
    <div class="help-info">
    <p>Enter a member ID to verify their status.</p>
    <p>
      You can find a member's ID on their membership certificate, or by one of the following methods:
      <ul>
        <li>If the member is a food pantry, click on the member status link on their pantry details card in the <a href="/food-pantries" target="_blank" rel="noopener noreferrer">Food Pantry Map</a>.</li>
      </ul>
    </p>
    </div>

    <form method="POST" data-astro-reload>
      <label for="memberId">Member ID</label>
      
      <input
        type="text"
        id="memberId"
        name="memberId"
        value={memberId}
        class="search-box"
        required
      />
      <button type="submit">Verify</button>
    </form>

    {
      error && (
        <div class="error">
          <p>{error}</p>
        </div>
      )
    }

    {
      memberData &&
        (() => {
          const isExpired =
            new Date(memberData.verification.verification_expiry) < new Date();
          const statusText = isExpired ? "Expired" : memberData.status.code;

          // Map status codes to CSS classes for styling
          const statusClassMap = {
            ACTIVE: "status-active",
            PENDING: "status-pending",
            FLAGGED: "status-flagged",
            BANNED: "status-banned",
            SUSPENDED: "status-suspended",
            Expired: "status-expired",
          };
          const statusClass = statusClassMap[statusText] || "";

          // Use the MEMBERSHIP_LEVEL_NAMES map in consts to get the membership level name
          const membershipLevelName =
            MEMBERSHIP_LEVEL_NAMES[memberData.id.split(".")[0]] ||
            "Unknown Membership Level";

          return (
            <div class="card">
              <h2>Verification Status for <span class="card-title"
              >{memberData.name}
              </span>
              </h2>
              <p>
                <strong>ID:</strong> 
                <span
                    class="card-member-id"
                >
                    {memberData.id}
                    </span>
              </p>
              <p>
                <strong>Membership Type:</strong> 
                <span
                    class="card-membership-type"
                >
                    {membershipLevelName}
                    </span>
              </p>
              <p>
                <strong>Membership Description:</strong>
                <span
                    class="card-membership-description"
                >{" "}
                {
                  MEMBERSHIP_LEVEL_DESCRIPTIONS[
                    memberData.id.split(".")[0]
                  ] || "No description available."
                }
                </span>
              <p>
                <strong>Status:</strong>
                <span class:list={["status-badge", statusClass]}>
                  {statusText}
                </span>
              </p>

              {memberData.status && memberData.status.message && (
                <details class="status-details">
                  <summary>Show Status Details</summary>
                  <div class="details-content">
                    <h4>Status Message</h4>
                    <p>{memberData.status.message}</p>
                    <h4>Last Updated By</h4>
                    <p>
                      {memberData.status.updated_by} on{" "}
                      {new Date(
                        memberData.status.updated_on
                      ).toLocaleDateString()}
                    </p>
                  </div>
                </details>
              )}

              <p>
                <strong>Verified By:</strong>
                <span
                    class="card-admin"
                    >{" "}
                {memberData.verification.verified_by}
                </span>
              </p>
              <p>
                <strong>Verified On:</strong>
                <span
                    class="card-admin"
                    >{" "}
                {new Date(
                  memberData.verification.verified_on
                ).toLocaleDateString()}
                </span>
              </p>
              <p>
                <strong>Verification Expires:</strong>
                <span
                    class={isExpired ? "status-badge card-admin-expired" : "card-admin"}
                >{" "}
                {new Date(
                  memberData.verification.verification_expiry
                ).toLocaleDateString()}
                </span>
              </p>

              <div class="report-member">
                <h3>Report Member</h3>
                <p>
                  If you believe this member is violating community guidelines, or, you would like to give them a commendation,
                  you can report them using one of the following methods:
                <ul>
                  <li>
                    <Icon
                        name="mdi:github"
                        size="16"
                        style="vertical-align: text-bottom; margin-right: 4px;"
                    />
                    <a
                      href={`https://github.com/corespark-io/community/issues/new?template=member_report.md&title=[MEMBER REPORT] ${encodeURIComponent(memberData.name)}&body=Member%20ID:%20${encodeURIComponent(memberData.id)}%0AVerification%20Link:%20https://community.corespark.io/members/verify?id=${encodeURIComponent(memberData.id)}`}
                      target="_blank"
                      rel="noopener noreferrer"
                    >
                      GitHub Issue
                    </a>
                  </li>
                  <li>
                    <Icon
                        name="mdi:email"
                        size="16"
                        style="vertical-align: text-bottom; margin-right: 4px;"
                    />
                    <a href={`mailto:community-member-reports@corespark.io?subject=[Member%20Report]:%20${memberData.name}&body=${encodeURIComponent(`Hello Community Team,

I Am Submitting A Report for ${memberData.name}. Please find the relevant details below.

- Member ID: ${memberData.id}
- Verification Link: https://community.corespark.io/members/verify?id=${memberData.id}
- This is a : Commendation/Complaint (Please Delete As Applicable)
- I would like to remain anonymous: Yes/No (Please Delete As Applicable)


Report Reason: 
[Provide Reason Here]
`)}`} target="_blank" rel="noopener noreferrer">
                      Email
                    </a>
                  </li>
                </ul>
              </div>
            </div>
          );
        })()
    }
  </main>
</Layout>

<style>
  .container {
    max-width: 600px;
    margin: 0.15rem auto;
    padding: 1rem;
  }
  .help-info {
    margin-bottom: 0.8rem;
    font-size: 0.95rem;
    color: var(--text-disclaimer);
  }
  .help-info p {
    margin-bottom: 0.35rem;
  }
  .help-info ul {
    padding-left: 1.5rem;

  }
  .help-info a {
    color: var(--accent-color);
    text-decoration: none;
  }
  form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-bottom: 2rem;
  }
  label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 700;
  }
  .search-box {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--color-border);
    background: var(--color-background);
    color: var(--color-text);
    border-radius: 5px;
    transition: border-color 0.3s;
  }
  .search-box:focus {
    outline: none;
    border-color: var(--accent-color);
  }
  button {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 5px;
    background: var(--accent-color);
    color: var(--light-color);
    font-weight: 700;
    cursor: pointer;
    transition: opacity 0.2s;
  }
  button:hover {
    opacity: 0.9;
  }
  .error {
    background-color: var(--error-color-soft);
    padding: 1rem;
    margin-bottom: 1rem;
    border: 1px solid var(--error-color);
    border-radius: 4px;
  }
  .error p {
    color: var(--text-color);
    margin: 0;
  }
  .card {
    border-radius: 10px;
    padding: 2rem;
    border: 1px solid var(--input-border);
  }
  .card h2 {
    text-align: left;
    margin-bottom: 1.5rem;
    font-size: 1.8rem;
  }
  .card p {
    margin-bottom: 1rem;
    font-size: 1rem;
  }
    .card-title {
        font-weight: 600;
        color: var(--accent-color);
    }
    .card-member-id {
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        color: var(--text-disclaimer);
    }
    .card-membership-type {
        font-weight: 500;
        color: var(--text-disclaimer);
    }
    .card-membership-description {
        font-style: italic;
        color: var(--text-disclaimer);
    }
    .card-admin {
        font-weight: 500;
        color: var(--text-disclaimer);
    }
    .card-admin-expired {
        font-weight: 500;
        color: var(--error-color);
    }
  .status-details {
    margin: 1rem 0;
  }
  .status-details summary {
    cursor: pointer;
    font-weight: bold;
    color: var(--text-disclaimer);
  }
  .details-content {
    border-left: 2px solid var(--input-border);
    padding-left: 1rem;
    margin-top: 0.5rem;
  }
  .report-member {
    margin-top: 2rem;
    padding-top: 1rem;
    border-top: 1px solid var(--input-border);
  }
  .report-member ul {
    padding: 0;
    list-style-type: none;
  }
  .report-member a {
    color: var(--accent-color);
    text-decoration: none;
  }
  .status-badge {
    display: inline-block;
    padding: 0.25em 0.6em;
    font-size: 0.85em;
    font-weight: 700;
    line-height: 1;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    border-radius: 0.25rem;
    margin-left: 0.5rem;
  }
  .status-active {
    color: #fff;
    background-color: #28a745;
  }
  .status-pending {
      color: #fff;
      background-color: #17a2b8;
  }
  .status-flagged {
    color: #212529;
    background-color: #ffc107;
  }
  .status-banned,
  .status-suspended,
  .status-expired {
    color: #fff;
    background-color: var(--error-color);
  }
</style>
