---
import { Image } from "astro:assets";
import { SITE_TITLE } from "../consts";
import { BASE_URL } from "../consts";
import HeaderLink from "./HeaderLink.astro";

const { pathname } = Astro.url;
const { title } = Astro.props;
const getSectionHref = (section: string) => {
  if (pathname === "/") {
    return `/#${section}`;
  }
  return `/${section}`;
};

const communityHomeHref = "/";
const foodPantriesHref = "/food-pantries";
---

<header class="masthead">
  <div class="container">
    <div class="logo-group">
      <a href={BASE_URL} class="logo-link" aria-label={`${SITE_TITLE} Home`}>
        <Image
          class="logo-light"
          src="/logo_w_text.webp"
          alt={`${SITE_TITLE} logo`}
          width="200"
          height="54"
          loading="eager"
        />
        <Image
          class="logo-dark"
          src="/logo_w_text_white.webp"
          alt={`${SITE_TITLE} logo`}
          width="200"
          height="54"
          loading="eager"
        />
      </a>
      <h3 class="logo-title">| {title}</h3>
    </div>

    <div class="nav-group">
      <nav>
        <div class="mobile-menu-header">
          <h2>Menu</h2>
          <button class="close-menu" aria-label="Close menu">
            <span class="close-icon" aria-hidden="true">Ã—</span>
          </button>
        </div>
        <ul class="nav-links">
          <li><HeaderLink href={communityHomeHref}>Home</HeaderLink></li>
          <li>
            <HeaderLink href={foodPantriesHref}>Food Pantries</HeaderLink>
          </li>
        </ul>
      </nav>
      <button class="menu-toggle" aria-label="Open menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
  </div>

  <!-- 100% privacy-first analytics -->
  <script async src="https://scripts.simpleanalyticscdn.com/latest.js"></script>
  <noscript
    ><img
      src="https://queue.simpleanalyticscdn.com/noscript.gif"
      alt=""
      referrerpolicy="no-referrer-when-downgrade"
    /></noscript
  >
  
</header>

<!-- Search Modal -->
<div id="search-modal" class="search-modal" hidden>
  <div class="search-modal-overlay" id="search-modal-overlay"></div>
  <div class="search-modal-content">
    <div class="search-modal-header">
      <h3 class="search-modal-title">Search Blog</h3>
      <button
        id="search-modal-close"
        class="search-modal-close"
        aria-label="Close search"
      >
        &times;
      </button>
    </div>
    <div class="search-input-wrapper">
      <input
        type="text"
        id="search-input"
        placeholder="Type to search..."
        autocomplete="off"
      />
      <div id="search-results" class="search-results"></div>
    </div>
  </div>
</div>

<script>
  import Fuse from "fuse.js";

  document.addEventListener("DOMContentLoaded", () => {
    // --- Mobile Menu Logic ---
    const menuToggle = document.querySelector(".menu-toggle");
    const closeMenu = document.querySelector(".close-menu");
    const nav = document.querySelector("header nav");
    const navLinks = document.querySelectorAll("header nav a");

    const toggleMenu = () => {
      nav?.classList.toggle("active");
      const isExpanded = nav?.classList.contains("active");
      menuToggle?.setAttribute("aria-expanded", String(isExpanded));
    };

    const handleNavClick = () => {
      if (window.innerWidth <= 768 && nav?.classList.contains("active")) {
        toggleMenu();
      }
    };

    if (menuToggle && nav) {
      menuToggle.addEventListener("click", toggleMenu);
    }
    if (closeMenu && nav) {
      closeMenu.addEventListener("click", toggleMenu);
    }
    navLinks.forEach((link) => link.addEventListener("click", handleNavClick));

    // --- Search Logic ---
    const searchToggle = document.getElementById("search-toggle");
    const searchModal = document.getElementById("search-modal");
    const searchModalClose = document.getElementById("search-modal-close");
    const searchModalOverlay = document.getElementById("search-modal-overlay");
    const searchInput = document.getElementById(
      "search-input"
    ) as HTMLInputElement;
    const searchResults = document.getElementById("search-results");

    let fuse;
    let searchData = [];

    const openSearch = async () => {
      if (!searchModal || !searchInput) return;
      searchModal.hidden = false;
      document.body.style.overflow = "hidden";
      searchInput.focus();

      if (searchData.length === 0) {
        try {
          const response = await fetch("/api/search.json");
          if (!response.ok) throw new Error("Search index not found");
          searchData = await response.json();
          fuse = new Fuse(searchData, {
            keys: ["title", "description", "body"],
            includeMatches: true,
            minMatchCharLength: 2,
            threshold: 0.4,
          });
        } catch (error) {
          console.error("Failed to load search data:", error);
          if (searchResults) {
            searchResults.innerHTML =
              '<p class="no-results">Error loading search data.</p>';
          }
        }
      }
    };

    const closeSearch = () => {
      if (!searchModal || !searchInput) return;
      searchModal.hidden = true;
      document.body.style.overflow = "";
      searchInput.value = "";
      if (searchResults) {
        searchResults.innerHTML = "";
      }
    };

    const handleSearch = () => {
      if (!fuse || !searchInput || !searchResults) return;
      const query = searchInput.value;
      if (query.length < 2) {
        searchResults.innerHTML = "";
        return;
      }
      const results = fuse.search(query);
      displayResults(results);
    };

    const displayResults = (results) => {
      if (!searchResults) return;
      searchResults.innerHTML = "";
      if (results.length === 0) {
        searchResults.innerHTML =
          '<p class="no-results">No articles found.</p>';
        return;
      }

      const resultsList = document.createElement("ul");
      results.slice(0, 10).forEach(({ item }) => {
        const li = document.createElement("li");
        const a = document.createElement("a");
        a.href = `/posts/${item.slug}`;

        // Text Content
        const textContent = document.createElement("div");
        textContent.className = "result-text";

        const title = document.createElement("span");
        title.className = "result-title";
        title.textContent = item.title;

        const date = new Date(item.pubDate).toLocaleDateString("en-US", {
          year: "numeric",
          month: "long",
          day: "numeric",
        });
        const dateEl = document.createElement("small");
        dateEl.className = "result-date";
        dateEl.textContent = date;

        const description = document.createElement("p");
        description.className = "result-description";
        description.textContent = item.description;

        textContent.appendChild(title);
        textContent.appendChild(dateEl);
        textContent.appendChild(description);

        a.appendChild(textContent);
        li.appendChild(a);
        resultsList.appendChild(li);
      });
      searchResults.appendChild(resultsList);
    };

    searchToggle?.addEventListener("click", openSearch);
    searchModalClose?.addEventListener("click", closeSearch);
    searchModalOverlay?.addEventListener("click", closeSearch);
    searchInput?.addEventListener("input", handleSearch);
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && searchModal && !searchModal.hidden) {
        closeSearch();
      }
    });
  });
</script>

<style>
  .masthead {
    width: 100%;
    background-color: var(--menu-bg);
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1000;
    transition: background-color 0.3s ease;
    height: 6rem;
  }

  .container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
    height: 100%;
  }

  .logo-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .logo-link {
    border-bottom: none;
    line-height: 1; /* Prevents extra space */
  }
  .logo-link:hover {
    background: transparent;
  }

  .logo-title {
    margin: 0;
    font-weight: 400;
    font-size: 1.5rem;
    color: var(--text-color);
    white-space: nowrap;
  }

  .nav-group {
    display: flex;
    align-items: center;
  }

  nav {
    display: flex;
    align-items: center;
  }

  /* Dark Mode Logo Toggle */
  .logo-dark {
    display: none;
  }
  .logo-light {
    display: block;
  }
  @media (prefers-color-scheme: dark) {
    :global(html:not(.theme-light)) .logo-dark {
      display: block;
    }
    :global(html:not(.theme-light)) .logo-light {
      display: none;
    }
  }
  :global(html.theme-dark) .logo-dark {
    display: block;
  }
  :global(html.theme-dark) .logo-light {
    display: none;
  }

  /* Desktop Navigation */
  .nav-links {
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .nav-links li {
    margin-left: 2rem;
  }

  .nav-links li a {
    text-decoration: none;
    color: var(--text-color);
    font-size: 1.2rem;
    position: relative;
    border-bottom: none;
    padding: 0.2rem 0;
    white-space: nowrap;
  }

  .nav-links li a:hover {
    background-image: var(--primary-gradient);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
  }

  .nav-links li a::after {
    content: "";
    position: absolute;
    bottom: -2px;
    left: 0;
    width: 0;
    height: 2px;
    background-image: var(--primary-gradient);
    transition: width 0.3s ease;
  }

  .nav-links li a:hover::after {
    width: 100%;
  }

  /* Search & Mobile Toggles */
  .search-toggle,
  .menu-toggle {
    display: flex;
    flex-direction: column;
    cursor: pointer;
    background: none;
    border: none;
    padding: 0.5rem;
    margin-left: 1rem;
    color: var(--text-color);
  }
  .search-toggle {
    font-size: 1.5rem;
  }

  .menu-toggle {
    display: none;
  }

  .menu-toggle span {
    width: 25px;
    height: 3px;
    background-color: var(--text-color);
    margin: 2px 0;
    transition: all 0.3s ease;
  }

  .mobile-menu-header {
    display: none;
  }

  /* Responsive Styles */
  @media (max-width: 992px) {
    .nav-links li {
      margin-left: 1rem;
    }
    .nav-links li a {
      font-size: 1rem;
    }
  }

  @media (max-width: 768px) {
    .logo-group .logo-link img {
      max-width: 150px;
      height: auto;
    }

    .logo-title {
      font-size: 1.2rem;
    }

    .menu-toggle {
      display: flex;
    }

    nav {
      position: fixed;
      top: 0;
      right: 0;
      height: 100vh;
      width: 75%;
      max-width: 320px;
      background-color: var(--menu-bg, var(--color-background));
      padding: 0;
      box-shadow: var(--menu-shadow, -5px 0 20px rgba(0, 0, 0, 0.2));
      transform: translateX(100%);
      transition: transform 0.3s ease;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      z-index: 999;
    }

    nav.active {
      transform: translateX(0);
    }

    .mobile-menu-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      border-bottom: 1px solid var(--menu-item-border, var(--color-border));
      flex-shrink: 0;
    }

    .mobile-menu-header h2 {
      margin: 0;
      color: var(--text-color);
      font-size: 1.2rem;
    }

    .close-menu {
      background: none;
      border: none;
      color: var(--text-color);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.5rem;
    }

    .close-icon {
      display: block;
      line-height: 1;
    }

    .nav-links {
      flex-direction: column;
      padding: 0;
      margin: 0;
      width: 100%;
      align-items: flex-start;
    }

    .nav-links li {
      margin: 0;
      width: 100%;
      border-bottom: 1px solid var(--menu-item-border, var(--color-border));
    }

    .nav-links li a {
      display: block;
      padding: 1rem;
      font-size: 1.1rem;
      transition: background-color 0.2s ease;
      width: 100%;
    }

    .nav-links li a:hover {
      background-color: rgba(var(--color-blue-rgb), 0.1);
      background-image: none;
      color: var(--accent);
    }

    .nav-links li a::after,
    .nav-links li a:hover::after {
      display: none;
    }
  }

  /* Search Modal Styles */
  .search-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 2000;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding-top: 15vh;
    visibility: hidden;
    opacity: 0;
    transition:
      visibility 0s 0.2s,
      opacity 0.2s ease;
  }
  .search-modal:not([hidden]) {
    visibility: visible;
    opacity: 1;
    transition:
      visibility 0s,
      opacity 0.2s ease;
  }
  .search-modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(5px);
  }
  .search-modal-content {
    position: relative;
    background: var(--color-background-soft);
    border-radius: 8px;
    width: 90%;
    max-width: 600px;
    z-index: 2001;
    box-shadow: var(--box-shadow-gradient);
  }
  .search-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--color-border);
  }
  .search-modal-title {
    margin: 0;
    font-size: 1.2rem;
    color: var(--color-heading);
  }
  .search-modal-close {
    background: none;
    border: none;
    font-size: 2rem;
    color: var(--color-text);
    cursor: pointer;
    line-height: 1;
  }
  .search-input-wrapper {
    padding: 1.5rem;
  }
  #search-input {
    width: 100%;
    padding: 0.75rem 1rem;
    font-size: 1.1rem;
    border-radius: 6px;
    border: 1px solid var(--color-border);
    background: var(--color-background);
    color: var(--color-text);
  }
  #search-input:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 2px var(--accent-translucent);
  }
  .search-results {
    margin-top: 1rem;
    max-height: 40vh;
    overflow-y: auto;
    padding-right: 0.5rem;
  }
  .search-results::-webkit-scrollbar {
    width: 8px;
  }
  .search-results::-webkit-scrollbar-track {
    background: transparent;
  }
  .search-results::-webkit-scrollbar-thumb {
    background-color: var(--color-border);
    border-radius: 10px;
    border: 2px solid var(--color-background-soft);
  }

  :global(.search-results ul) {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  :global(.search-results li a) {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    padding: 1rem;
    text-decoration: none;
    border-radius: 6px;
    transition:
      background-color 0.2s ease,
      transform 0.2s ease;
  }
  :global(.search-results li a:hover) {
    background-color: var(--color-background-mute);
    transform: translateY(-2px);
  }
  :global(.result-text) {
    flex-grow: 1;
  }
  :global(.search-results .result-title) {
    display: block;
    font-size: 1.05rem;
    font-weight: 600;
    color: var(--color-heading);
    line-height: 1.3;
  }
  :global(.search-results .result-date) {
    display: block;
    font-size: 0.8rem;
    color: var(--color-text-soft);
    margin-top: 0.25rem;
  }
  :global(.search-results .result-description) {
    font-size: 0.9rem;
    color: var(--color-text);
    margin: 0.5rem 0 0;
    line-height: 1.5;
  }
  :global(.no-results) {
    padding: 2rem 1rem;
    text-align: center;
    color: var(--color-text-soft);
  }
</style>

<style is:global>
  body {
    padding-top: 6rem; /* Match header height */
  }
</style>
